<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Bot Monitoring Dashboard</title>
        <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
        <style>
            :root {
                --bg-primary: #0d1117;
                --bg-secondary: #161b22;
                --bg-tertiary: #21262d;
                --border-color: #30363d;
                --text-primary: #c9d1d9;
                --text-secondary: #8b949e;
                --accent-blue: #58a6ff;
                --accent-green: #3fb950;
                --accent-red: #f85149;
                --accent-yellow: #d29922;
                --accent-purple: #a371f7;
                --accent-orange: #f0883e;
            }

            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family:
                    -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans',
                    Helvetica, Arial, sans-serif;
                background: var(--bg-primary);
                color: var(--text-primary);
                line-height: 1.5;
            }

            .header {
                background: var(--bg-secondary);
                border-bottom: 1px solid var(--border-color);
                padding: 16px 24px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                position: sticky;
                top: 0;
                z-index: 100;
            }

            .header h1 {
                font-size: 20px;
                font-weight: 600;
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .header h1::before {
                content: 'ðŸ“Š';
            }

            .status-badge {
                display: flex;
                align-items: center;
                gap: 8px;
                padding: 6px 12px;
                background: var(--bg-tertiary);
                border-radius: 20px;
                font-size: 13px;
            }

            .status-dot {
                width: 8px;
                height: 8px;
                border-radius: 50%;
                background: var(--accent-green);
                animation: pulse 2s infinite;
            }

            @keyframes pulse {
                0%,
                100% {
                    opacity: 1;
                }
                50% {
                    opacity: 0.5;
                }
            }

            .container {
                max-width: 1600px;
                margin: 0 auto;
                padding: 24px;
            }

            .tabs {
                display: flex;
                gap: 8px;
                margin-bottom: 24px;
                border-bottom: 1px solid var(--border-color);
                padding-bottom: 8px;
            }

            .tab {
                padding: 8px 16px;
                background: none;
                border: none;
                color: var(--text-secondary);
                cursor: pointer;
                font-size: 14px;
                border-radius: 6px;
                transition: all 0.2s;
            }

            .tab:hover {
                color: var(--text-primary);
                background: var(--bg-tertiary);
            }

            .tab.active {
                color: var(--text-primary);
                background: var(--bg-secondary);
                border: 1px solid var(--border-color);
            }

            .tab-content {
                display: none;
            }

            .tab-content.active {
                display: block;
            }

            .stats-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 16px;
                margin-bottom: 24px;
            }

            .stat-card {
                background: var(--bg-secondary);
                border: 1px solid var(--border-color);
                border-radius: 8px;
                padding: 16px;
            }

            .stat-card .label {
                color: var(--text-secondary);
                font-size: 12px;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                margin-bottom: 4px;
            }

            .stat-card .value {
                font-size: 28px;
                font-weight: 600;
                color: var(--text-primary);
            }

            .stat-card .subvalue {
                font-size: 12px;
                color: var(--text-secondary);
                margin-top: 4px;
            }

            .stat-card.error .value {
                color: var(--accent-red);
            }

            .stat-card.success .value {
                color: var(--accent-green);
            }

            .charts-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
                gap: 24px;
                margin-bottom: 24px;
            }

            .chart-card {
                background: var(--bg-secondary);
                border: 1px solid var(--border-color);
                border-radius: 8px;
                padding: 20px;
            }

            .chart-card h3 {
                font-size: 14px;
                font-weight: 600;
                margin-bottom: 16px;
                color: var(--text-secondary);
            }

            .chart-container {
                position: relative;
                height: 250px;
            }

            /* Trace Search */
            .search-section {
                background: var(--bg-secondary);
                border: 1px solid var(--border-color);
                border-radius: 8px;
                padding: 20px;
                margin-bottom: 24px;
            }

            .search-form {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 16px;
                align-items: end;
            }

            .form-group {
                display: flex;
                flex-direction: column;
                gap: 6px;
            }

            .form-group label {
                font-size: 12px;
                color: var(--text-secondary);
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }

            .form-group input,
            .form-group select {
                background: var(--bg-tertiary);
                border: 1px solid var(--border-color);
                border-radius: 6px;
                padding: 8px 12px;
                color: var(--text-primary);
                font-size: 14px;
            }

            .form-group input:focus,
            .form-group select:focus {
                outline: none;
                border-color: var(--accent-blue);
            }

            .btn {
                padding: 8px 16px;
                border-radius: 6px;
                font-size: 14px;
                font-weight: 500;
                cursor: pointer;
                border: none;
                transition: all 0.2s;
            }

            .btn-primary {
                background: var(--accent-blue);
                color: white;
            }

            .btn-primary:hover {
                filter: brightness(1.1);
            }

            .btn-secondary {
                background: var(--bg-tertiary);
                color: var(--text-primary);
                border: 1px solid var(--border-color);
            }

            /* Traces Table */
            .traces-table {
                width: 100%;
                border-collapse: collapse;
                font-size: 13px;
            }

            .traces-table th {
                text-align: left;
                padding: 12px;
                background: var(--bg-tertiary);
                color: var(--text-secondary);
                font-weight: 600;
                text-transform: uppercase;
                font-size: 11px;
                letter-spacing: 0.5px;
                border-bottom: 1px solid var(--border-color);
            }

            .traces-table td {
                padding: 12px;
                border-bottom: 1px solid var(--border-color);
                vertical-align: top;
            }

            .traces-table tr:hover {
                background: var(--bg-tertiary);
            }

            .trace-id {
                font-family: 'SF Mono', Monaco, 'Courier New', monospace;
                font-size: 12px;
                color: var(--accent-blue);
                cursor: pointer;
            }

            .trace-id:hover {
                text-decoration: underline;
            }

            .status-badge-table {
                display: inline-block;
                padding: 2px 8px;
                border-radius: 12px;
                font-size: 11px;
                font-weight: 500;
            }

            .status-success {
                background: rgba(63, 185, 80, 0.2);
                color: var(--accent-green);
            }

            .status-error {
                background: rgba(248, 81, 73, 0.2);
                color: var(--accent-red);
            }

            .status-pending {
                background: rgba(210, 153, 34, 0.2);
                color: var(--accent-yellow);
            }

            .operation-type {
                display: inline-block;
                padding: 2px 8px;
                border-radius: 4px;
                font-size: 11px;
                background: var(--bg-tertiary);
                color: var(--text-secondary);
            }

            /* Trace Detail Modal */
            .modal {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                z-index: 1000;
                align-items: center;
                justify-content: center;
            }

            .modal.active {
                display: flex;
            }

            .modal-content {
                background: var(--bg-secondary);
                border: 1px solid var(--border-color);
                border-radius: 12px;
                width: 90%;
                max-width: 900px;
                max-height: 80vh;
                overflow: auto;
            }

            .modal-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 16px 20px;
                border-bottom: 1px solid var(--border-color);
                position: sticky;
                top: 0;
                background: var(--bg-secondary);
            }

            .modal-header h2 {
                font-size: 16px;
                font-weight: 600;
            }

            .modal-close {
                background: none;
                border: none;
                color: var(--text-secondary);
                font-size: 24px;
                cursor: pointer;
                line-height: 1;
            }

            .modal-close:hover {
                color: var(--text-primary);
            }

            .modal-body {
                padding: 20px;
            }

            .trace-detail-header {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 16px;
                margin-bottom: 24px;
            }

            .trace-detail-item {
                background: var(--bg-tertiary);
                padding: 12px;
                border-radius: 6px;
            }

            .trace-detail-item .label {
                font-size: 11px;
                color: var(--text-secondary);
                text-transform: uppercase;
                margin-bottom: 4px;
            }

            .trace-detail-item .value {
                font-size: 14px;
                font-weight: 500;
                word-break: break-all;
            }

            .spans-timeline {
                margin-top: 24px;
            }

            .spans-timeline h3 {
                font-size: 14px;
                margin-bottom: 12px;
                color: var(--text-secondary);
            }

            .span-item {
                background: var(--bg-tertiary);
                border-radius: 6px;
                padding: 12px;
                margin-bottom: 8px;
                border-left: 3px solid var(--accent-blue);
            }

            .span-item.error {
                border-left-color: var(--accent-red);
            }

            .span-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 8px;
            }

            .span-name {
                font-weight: 500;
            }

            .span-duration {
                font-size: 12px;
                color: var(--text-secondary);
            }

            .span-tags {
                display: flex;
                flex-wrap: wrap;
                gap: 6px;
            }

            .span-tag {
                font-size: 11px;
                padding: 2px 6px;
                background: var(--bg-secondary);
                border-radius: 4px;
                color: var(--text-secondary);
            }

            .span-logs {
                margin-top: 8px;
                font-size: 12px;
                font-family: 'SF Mono', Monaco, 'Courier New', monospace;
                color: var(--text-secondary);
            }

            .span-log {
                padding: 4px 0;
                border-top: 1px solid var(--border-color);
            }

            /* Errors Table */
            .errors-section {
                background: var(--bg-secondary);
                border: 1px solid var(--border-color);
                border-radius: 8px;
                padding: 20px;
            }

            .errors-section h3 {
                font-size: 14px;
                margin-bottom: 16px;
                color: var(--accent-red);
            }

            .error-item {
                padding: 12px;
                background: var(--bg-tertiary);
                border-radius: 6px;
                margin-bottom: 8px;
                border-left: 3px solid var(--accent-red);
            }

            .error-header {
                display: flex;
                justify-content: space-between;
                margin-bottom: 4px;
            }

            .error-name {
                font-weight: 500;
                color: var(--accent-red);
            }

            .error-time {
                font-size: 12px;
                color: var(--text-secondary);
            }

            .error-message {
                font-size: 13px;
                color: var(--text-secondary);
                font-family: 'SF Mono', Monaco, 'Courier New', monospace;
            }

            /* Loading */
            .loading {
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 40px;
                color: var(--text-secondary);
            }

            .spinner {
                width: 24px;
                height: 24px;
                border: 2px solid var(--border-color);
                border-top-color: var(--accent-blue);
                border-radius: 50%;
                animation: spin 1s linear infinite;
                margin-right: 12px;
            }

            @keyframes spin {
                to {
                    transform: rotate(360deg);
                }
            }

            /* Latency percentiles */
            .latency-grid {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 12px;
                margin-top: 16px;
            }

            .latency-item {
                text-align: center;
                padding: 12px;
                background: var(--bg-tertiary);
                border-radius: 6px;
            }

            .latency-item .percentile {
                font-size: 11px;
                color: var(--text-secondary);
                text-transform: uppercase;
            }

            .latency-item .ms {
                font-size: 20px;
                font-weight: 600;
                margin-top: 4px;
            }

            /* Refresh button */
            .refresh-controls {
                display: flex;
                gap: 12px;
                align-items: center;
            }

            .auto-refresh {
                display: flex;
                align-items: center;
                gap: 6px;
                font-size: 13px;
                color: var(--text-secondary);
            }

            .auto-refresh input {
                accent-color: var(--accent-blue);
            }
        </style>
    </head>
    <body>
        <header class="header">
            <h1>Bot Monitoring Dashboard</h1>
            <div class="refresh-controls">
                <label class="auto-refresh">
                    <input type="checkbox" id="autoRefresh" checked />
                    Auto-refresh (5s)
                </label>
                <button class="btn btn-secondary" onclick="refreshData()">
                    Refresh Now
                </button>
                <div class="status-badge">
                    <span class="status-dot"></span>
                    <span id="uptime">Loading...</span>
                </div>
            </div>
        </header>

        <div class="container">
            <div class="tabs">
                <button class="tab active" data-tab="overview">Overview</button>
                <button class="tab" data-tab="traces">Traces</button>
                <button class="tab" data-tab="errors">Errors</button>
            </div>

            <!-- Overview Tab -->
            <div id="overview" class="tab-content active">
                <div class="stats-grid" id="statsGrid">
                    <div class="stat-card">
                        <div class="label">Messages Received</div>
                        <div class="value" id="statMessages">-</div>
                        <div class="subvalue" id="statMessagesRate">-/min</div>
                    </div>
                    <div class="stat-card">
                        <div class="label">Commands Executed</div>
                        <div class="value" id="statCommands">-</div>
                        <div class="subvalue" id="statCommandsRate">-/min</div>
                    </div>
                    <div class="stat-card">
                        <div class="label">Inline Queries</div>
                        <div class="value" id="statInline">-</div>
                        <div class="subvalue" id="statInlineRate">-/min</div>
                    </div>
                    <div class="stat-card">
                        <div class="label">Scheduled Tasks</div>
                        <div class="value" id="statScheduled">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="label">API Requests</div>
                        <div class="value" id="statApi">-</div>
                    </div>
                    <div class="stat-card error">
                        <div class="label">Errors</div>
                        <div class="value" id="statErrors">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="label">Active Traces</div>
                        <div class="value" id="statActiveTraces">-</div>
                    </div>
                    <div class="stat-card success">
                        <div class="label">Avg Latency</div>
                        <div class="value" id="statAvgLatency">-</div>
                        <div class="subvalue">messages</div>
                    </div>
                </div>

                <div class="charts-grid">
                    <div class="chart-card">
                        <h3>Throughput (per minute)</h3>
                        <div class="chart-container">
                            <canvas id="throughputChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <h3>Error Rate</h3>
                        <div class="chart-container">
                            <canvas id="errorChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <h3>Latency Distribution (messages)</h3>
                        <div class="chart-container">
                            <canvas id="latencyHistogram"></canvas>
                        </div>
                        <div class="latency-grid">
                            <div class="latency-item">
                                <div class="percentile">P50</div>
                                <div class="ms" id="p50">-</div>
                            </div>
                            <div class="latency-item">
                                <div class="percentile">P95</div>
                                <div class="ms" id="p95">-</div>
                            </div>
                            <div class="latency-item">
                                <div class="percentile">P99</div>
                                <div class="ms" id="p99">-</div>
                            </div>
                        </div>
                    </div>
                    <div class="chart-card">
                        <h3>Operations Breakdown</h3>
                        <div class="chart-container">
                            <canvas id="operationsChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Traces Tab -->
            <div id="traces" class="tab-content">
                <div class="search-section">
                    <form class="search-form" id="traceSearchForm">
                        <div class="form-group">
                            <label for="searchTraceId">Trace ID</label>
                            <input
                                type="text"
                                id="searchTraceId"
                                placeholder="Search by trace ID..."
                            />
                        </div>
                        <div class="form-group">
                            <label for="searchBot">Bot</label>
                            <select id="searchBot">
                                <option value="">All Bots</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="searchOperationType"
                                >Operation Type</label
                            >
                            <select id="searchOperationType">
                                <option value="">All Types</option>
                                <option value="message">Message</option>
                                <option value="command">Command</option>
                                <option value="inline">Inline</option>
                                <option value="scheduled">Scheduled</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="searchStatus">Status</label>
                            <select id="searchStatus">
                                <option value="">All</option>
                                <option value="success">Success</option>
                                <option value="error">Error</option>
                                <option value="pending">Pending</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="searchMinDuration"
                                >Min Duration (ms)</label
                            >
                            <input
                                type="number"
                                id="searchMinDuration"
                                placeholder="0"
                            />
                        </div>
                        <div class="form-group">
                            <label for="searchMaxDuration"
                                >Max Duration (ms)</label
                            >
                            <input
                                type="number"
                                id="searchMaxDuration"
                                placeholder="10000"
                            />
                        </div>
                        <div class="form-group">
                            <button type="submit" class="btn btn-primary">
                                Search
                            </button>
                        </div>
                    </form>
                </div>

                <div class="chart-card">
                    <table class="traces-table">
                        <thead>
                            <tr>
                                <th>Trace ID</th>
                                <th>Bot</th>
                                <th>Operation</th>
                                <th>Type</th>
                                <th>Duration</th>
                                <th>Status</th>
                                <th>Time</th>
                            </tr>
                        </thead>
                        <tbody id="tracesTableBody">
                            <tr>
                                <td colspan="7" class="loading">
                                    <div class="spinner"></div>
                                    Loading traces...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Errors Tab -->
            <div id="errors" class="tab-content">
                <div class="errors-section">
                    <h3>ðŸš¨ Recent Errors</h3>
                    <div id="errorsContainer">
                        <div class="loading">
                            <div class="spinner"></div>
                            Loading errors...
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Trace Detail Modal -->
        <div class="modal" id="traceModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Trace Details</h2>
                    <button class="modal-close" onclick="closeModal()">
                        &times;
                    </button>
                </div>
                <div class="modal-body" id="traceModalBody">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>

        <script>
            // Chart instances
            let throughputChart, errorChart, latencyHistogram, operationsChart;
            let refreshInterval;
            let currentData = null;

            // Initialize
            document.addEventListener('DOMContentLoaded', () => {
                initCharts();
                initTabs();
                initTraceSearch();
                refreshData();
                startAutoRefresh();
            });

            function initCharts() {
                const chartDefaults = {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#8b949e' }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#8b949e' },
                            grid: { color: '#30363d' }
                        },
                        y: {
                            ticks: { color: '#8b949e' },
                            grid: { color: '#30363d' },
                            beginAtZero: true
                        }
                    }
                };

                // Throughput Chart
                throughputChart = new Chart(
                    document.getElementById('throughputChart'),
                    {
                        type: 'line',
                        data: {
                            labels: [],
                            datasets: [
                                {
                                    label: 'Messages',
                                    data: [],
                                    borderColor: '#58a6ff',
                                    fill: false,
                                    tension: 0.3
                                },
                                {
                                    label: 'Commands',
                                    data: [],
                                    borderColor: '#3fb950',
                                    fill: false,
                                    tension: 0.3
                                },
                                {
                                    label: 'Inline',
                                    data: [],
                                    borderColor: '#a371f7',
                                    fill: false,
                                    tension: 0.3
                                }
                            ]
                        },
                        options: chartDefaults
                    }
                );

                // Error Chart
                errorChart = new Chart(document.getElementById('errorChart'), {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [
                            {
                                label: 'Errors',
                                data: [],
                                borderColor: '#f85149',
                                backgroundColor: 'rgba(248,81,73,0.1)',
                                fill: true,
                                tension: 0.3
                            }
                        ]
                    },
                    options: chartDefaults
                });

                // Latency Histogram
                latencyHistogram = new Chart(
                    document.getElementById('latencyHistogram'),
                    {
                        type: 'bar',
                        data: {
                            labels: [
                                '<10ms',
                                '<25ms',
                                '<50ms',
                                '<100ms',
                                '<250ms',
                                '<500ms',
                                '<1s',
                                '<2.5s',
                                '<5s',
                                '<10s',
                                '>10s'
                            ],
                            datasets: [
                                {
                                    label: 'Requests',
                                    data: [],
                                    backgroundColor: '#58a6ff'
                                }
                            ]
                        },
                        options: {
                            ...chartDefaults,
                            plugins: { legend: { display: false } }
                        }
                    }
                );

                // Operations Pie Chart
                operationsChart = new Chart(
                    document.getElementById('operationsChart'),
                    {
                        type: 'doughnut',
                        data: {
                            labels: [
                                'Messages',
                                'Commands',
                                'Inline',
                                'Scheduled',
                                'API'
                            ],
                            datasets: [
                                {
                                    data: [0, 0, 0, 0, 0],
                                    backgroundColor: [
                                        '#58a6ff',
                                        '#3fb950',
                                        '#a371f7',
                                        '#f0883e',
                                        '#d29922'
                                    ]
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'right',
                                    labels: { color: '#8b949e' }
                                }
                            }
                        }
                    }
                );
            }

            function initTabs() {
                document.querySelectorAll('.tab').forEach((tab) => {
                    tab.addEventListener('click', () => {
                        document
                            .querySelectorAll('.tab')
                            .forEach((t) => t.classList.remove('active'));
                        document
                            .querySelectorAll('.tab-content')
                            .forEach((c) => c.classList.remove('active'));
                        tab.classList.add('active');
                        document
                            .getElementById(tab.dataset.tab)
                            .classList.add('active');
                    });
                });
            }

            function initTraceSearch() {
                document
                    .getElementById('traceSearchForm')
                    .addEventListener('submit', (e) => {
                        e.preventDefault();
                        searchTraces();
                    });
            }

            function startAutoRefresh() {
                const checkbox = document.getElementById('autoRefresh');
                checkbox.addEventListener('change', () => {
                    if (checkbox.checked) {
                        refreshInterval = setInterval(refreshData, 300);
                    } else {
                        clearInterval(refreshInterval);
                    }
                });
                refreshInterval = setInterval(refreshData, 300);
            }

            async function refreshData() {
                try {
                    const response = await fetch('/api/dashboard');
                    currentData = await response.json();
                    updateDashboard(currentData);
                } catch (error) {
                    console.error('Failed to fetch dashboard data:', error);
                }
            }

            function updateDashboard(data) {
                // Update stats
                const stats = data.currentStats;
                document.getElementById('statMessages').textContent =
                    formatNumber(stats.totalMessagesReceived);
                document.getElementById('statCommands').textContent =
                    formatNumber(stats.totalCommandsExecuted);
                document.getElementById('statInline').textContent =
                    formatNumber(stats.totalInlineQueries);
                document.getElementById('statScheduled').textContent =
                    formatNumber(stats.totalScheduledTasks);
                document.getElementById('statApi').textContent = formatNumber(
                    stats.totalApiRequests
                );
                document.getElementById('statErrors').textContent =
                    formatNumber(stats.totalErrors);
                document.getElementById('statActiveTraces').textContent =
                    formatNumber(stats.activeTraces);
                document.getElementById('statAvgLatency').textContent =
                    `${Math.round(stats.avgMessageLatency)}ms`;
                document.getElementById('uptime').textContent = formatUptime(
                    stats.uptime
                );

                // Calculate rates
                const throughput = data.throughput;
                const recentMessages = throughput.messagesReceived.slice(-5);
                const avgRate =
                    recentMessages.length > 0
                        ? recentMessages.reduce((sum, p) => sum + p.value, 0) /
                          recentMessages.length
                        : 0;
                document.getElementById('statMessagesRate').textContent =
                    `${avgRate.toFixed(1)}/min`;

                // Update percentiles
                document.getElementById('p50').textContent =
                    `${Math.round(stats.p50MessageLatency)}ms`;
                document.getElementById('p95').textContent =
                    `${Math.round(stats.p95MessageLatency)}ms`;
                document.getElementById('p99').textContent =
                    `${Math.round(stats.p99MessageLatency)}ms`;

                // Update throughput chart
                const labels = throughput.messagesReceived.map((p) =>
                    formatTime(p.timestamp)
                );
                throughputChart.data.labels = labels;
                throughputChart.data.datasets[0].data =
                    throughput.messagesReceived.map((p) => p.value);
                throughputChart.data.datasets[1].data =
                    throughput.commandsExecuted.map((p) => p.value);
                throughputChart.data.datasets[2].data =
                    throughput.inlineQueriesProcessed.map((p) => p.value);
                throughputChart.update('none');

                // Update error chart
                errorChart.data.labels = labels;
                errorChart.data.datasets[0].data = throughput.errors.map(
                    (p) => p.value
                );
                errorChart.update('none');

                // Update latency histogram
                const histogram = data.latencyHistogram;
                const histogramData = [];
                for (let i = 0; i < histogram.length; i++) {
                    const current = histogram[i].count;
                    const prev = i > 0 ? histogram[i - 1].count : 0;
                    histogramData.push(current - prev);
                }
                latencyHistogram.data.datasets[0].data = histogramData;
                latencyHistogram.update('none');

                // Update operations chart
                operationsChart.data.datasets[0].data = [
                    stats.totalMessagesReceived,
                    stats.totalCommandsExecuted,
                    stats.totalInlineQueries,
                    stats.totalScheduledTasks,
                    stats.totalApiRequests
                ];
                operationsChart.update('none');

                // Update bot selector
                const botSelect = document.getElementById('searchBot');
                const currentValue = botSelect.value;
                botSelect.innerHTML = '<option value="">All Bots</option>';
                data.botNames.forEach((name) => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    botSelect.appendChild(option);
                });
                botSelect.value = currentValue;

                // Update traces table
                updateTracesTable(data.recentTraces);

                // Update errors
                updateErrors(data.recentErrors);
            }

            function updateTracesTable(traces) {
                const tbody = document.getElementById('tracesTableBody');
                if (traces.length === 0) {
                    tbody.innerHTML =
                        '<tr><td colspan="7" style="text-align:center;color:#8b949e;">No traces found</td></tr>';
                    return;
                }

                tbody.innerHTML = traces
                    .map(
                        (trace) => `
                <tr>
                    <td><span class="trace-id" onclick="showTraceDetail('${trace.traceId}')">${trace.traceId.substring(0, 8)}...</span></td>
                    <td>${trace.botName}</td>
                    <td>${trace.rootSpan.operationName}</td>
                    <td><span class="operation-type">${trace.operationType}</span></td>
                    <td>${trace.totalDuration !== undefined ? trace.totalDuration + 'ms' : '-'}</td>
                    <td><span class="status-badge-table status-${trace.rootSpan.status}">${trace.rootSpan.status}</span></td>
                    <td>${formatDateTime(trace.startTime)}</td>
                </tr>
            `
                    )
                    .join('');
            }

            function updateErrors(errors) {
                const container = document.getElementById('errorsContainer');
                if (errors.length === 0) {
                    container.innerHTML =
                        '<div style="text-align:center;color:#8b949e;padding:20px;">No errors recorded</div>';
                    return;
                }

                container.innerHTML = errors
                    .map(
                        (err) => `
                <div class="error-item">
                    <div class="error-header">
                        <span class="error-name">${escapeHtml(err.name)}</span>
                        <span class="error-time">${formatDateTime(err.timestamp)}</span>
                    </div>
                    <div class="error-message">${escapeHtml(err.message)}</div>
                    ${err.traceId ? `<div style="margin-top:8px;"><span class="trace-id" onclick="showTraceDetail('${err.traceId}')">Trace: ${err.traceId.substring(0, 8)}...</span></div>` : ''}
                </div>
            `
                    )
                    .join('');
            }

            async function searchTraces() {
                const params = new URLSearchParams();

                const traceId = document.getElementById('searchTraceId').value;
                const botName = document.getElementById('searchBot').value;
                const operationType = document.getElementById(
                    'searchOperationType'
                ).value;
                const status = document.getElementById('searchStatus').value;
                const minDuration =
                    document.getElementById('searchMinDuration').value;
                const maxDuration =
                    document.getElementById('searchMaxDuration').value;

                if (traceId) params.set('traceId', traceId);
                if (botName) params.set('botName', botName);
                if (operationType) params.set('operationType', operationType);
                if (status) params.set('status', status);
                if (minDuration) params.set('minDuration', minDuration);
                if (maxDuration) params.set('maxDuration', maxDuration);
                params.set('limit', '100');

                try {
                    const response = await fetch(
                        `/api/traces?${params.toString()}`
                    );
                    const traces = await response.json();
                    updateTracesTable(traces);
                } catch (error) {
                    console.error('Failed to search traces:', error);
                }
            }

            async function showTraceDetail(traceId) {
                try {
                    const response = await fetch(`/api/trace/${traceId}`);
                    if (!response.ok) {
                        alert('Trace not found');
                        return;
                    }
                    const trace = await response.json();

                    const body = document.getElementById('traceModalBody');
                    body.innerHTML = `
                    <div class="trace-detail-header">
                        <div class="trace-detail-item">
                            <div class="label">Trace ID</div>
                            <div class="value">${trace.traceId}</div>
                        </div>
                        <div class="trace-detail-item">
                            <div class="label">Bot</div>
                            <div class="value">${trace.botName}</div>
                        </div>
                        <div class="trace-detail-item">
                            <div class="label">Operation Type</div>
                            <div class="value">${trace.operationType}</div>
                        </div>
                        <div class="trace-detail-item">
                            <div class="label">Duration</div>
                            <div class="value">${trace.totalDuration !== undefined ? trace.totalDuration + 'ms' : 'In progress'}</div>
                        </div>
                        <div class="trace-detail-item">
                            <div class="label">Status</div>
                            <div class="value"><span class="status-badge-table status-${trace.rootSpan.status}">${trace.rootSpan.status}</span></div>
                        </div>
                        <div class="trace-detail-item">
                            <div class="label">Start Time</div>
                            <div class="value">${formatDateTime(trace.startTime)}</div>
                        </div>
                    </div>
                    
                    <div class="spans-timeline">
                        <h3>Spans (${trace.spans.length})</h3>
                        ${trace.spans
                            .map(
                                (span) => `
                            <div class="span-item ${span.status === 'error' ? 'error' : ''}">
                                <div class="span-header">
                                    <span class="span-name">${span.operationName}</span>
                                    <span class="span-duration">${span.duration !== undefined ? span.duration + 'ms' : 'pending'}</span>
                                </div>
                                <div class="span-tags">
                                    ${Object.entries(span.tags)
                                        .map(
                                            ([k, v]) =>
                                                `<span class="span-tag">${k}: ${v}</span>`
                                        )
                                        .join('')}
                                </div>
                                ${
                                    span.logs.length > 0
                                        ? `
                                    <div class="span-logs">
                                        ${span.logs.map((log) => `<div class="span-log">[${formatTime(log.timestamp)}] ${escapeHtml(log.message)}</div>`).join('')}
                                    </div>
                                `
                                        : ''
                                }
                            </div>
                        `
                            )
                            .join('')}
                    </div>
                `;

                    document
                        .getElementById('traceModal')
                        .classList.add('active');
                } catch (error) {
                    console.error('Failed to load trace detail:', error);
                }
            }

            function closeModal() {
                document
                    .getElementById('traceModal')
                    .classList.remove('active');
            }

            // Close modal on escape
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') closeModal();
            });

            // Close modal on backdrop click
            document
                .getElementById('traceModal')
                .addEventListener('click', (e) => {
                    if (e.target.classList.contains('modal')) closeModal();
                });

            // Utility functions
            function formatNumber(num) {
                if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
                if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
                return num.toString();
            }

            function formatUptime(ms) {
                const seconds = Math.floor(ms / 1000);
                const minutes = Math.floor(seconds / 60);
                const hours = Math.floor(minutes / 60);
                const days = Math.floor(hours / 24);

                if (days > 0) return `${days}d ${hours % 24}h`;
                if (hours > 0) return `${hours}h ${minutes % 60}m`;
                if (minutes > 0) return `${minutes}m ${seconds % 60}s`;
                return `${seconds}s`;
            }

            function formatTime(timestamp) {
                return new Date(timestamp).toLocaleTimeString('en-US', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }

            function formatDateTime(timestamp) {
                return new Date(timestamp).toLocaleString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
            }

            function escapeHtml(str) {
                const div = document.createElement('div');
                div.textContent = str;
                return div.innerHTML;
            }
        </script>
    </body>
</html>
